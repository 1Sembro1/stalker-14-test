using Content.Client.UserInterface.Controls;
using Content.Shared._Stalker.Bands;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using System;
using Robust.Client.UserInterface.Controls;

namespace Content.Client._Stalker.Bands.UI
{
    [GenerateTypedNameReferences]
    public sealed partial class BandsManagingWindow : FancyWindow
    {
        public event Action<string>? OnAddMemberButtonPressed;
        public event Action<Guid>? OnRemoveMemberButtonPressed;

        public BandsManagingWindow()
        {
            RobustXamlLoader.Load(this);
            IoCManager.InjectDependencies(this);
            AddMemberButton.OnPressed += OnAddMemberPressed;
        }

        private void OnAddMemberPressed(BaseButton.ButtonEventArgs args)
        {
            OnAddMemberButtonPressed?.Invoke(AddMemberLineEdit.Text);
            AddMemberLineEdit.Text = string.Empty;
        }

        public void UpdateState(BandsManagingBoundUserInterfaceState state)
        {
            BandNameLabel.Text = state.BandName ?? Loc.GetString("bands-managing-window-band-name-unknown");
            BandMemberCountLabel.Text = $"{state.Members.Count} / {state.MaxMembers}";

            MembersList.Children.Clear();

            if (state.Members.Count == 0)
            {
                MembersList.Children.Add(NoMembersLabel);
                NoMembersLabel.Visible = true;
            }
            else
            {
                NoMembersLabel.Visible = false;
                foreach (var member in state.Members)
                {
                    var memberBox = new BoxContainer
                    {
                        Orientation = BoxContainer.LayoutOrientation.Horizontal,
                        HorizontalExpand = true,
                        Margin = new Thickness(0, 2)
                    };

                    var nameLabel = new Label
                    {
                        Text = member.PlayerName,
                        HorizontalExpand = true,
                    };

                    var removeButton = new Button
                    {
                        Text = Loc.GetString("bands-managing-window-remove-button"),
                        MinWidth = 80,
                        HorizontalAlignment = HAlignment.Right
                    };

                    var memberId = member.UserId;
                    removeButton.OnPressed += _ => OnRemoveMemberButtonPressed?.Invoke(memberId);

                    memberBox.AddChild(nameLabel);
                    memberBox.AddChild(removeButton);

                    MembersList.AddChild(memberBox);
                }
            }

            var canManage = state.CanManage;
            AddMemberLineEdit.Editable = canManage;
            AddMemberButton.Disabled = !canManage;
        }

        protected override void Dispose(bool disposing)
        {
            base.Dispose(disposing);
            if (disposing)
            {
                AddMemberButton.OnPressed -= OnAddMemberPressed;
            }
        }
    }
}
